<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quarterly Income-Expense 2025 Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="layout-loader.js"></script>

  <style>
    /* Your original styles, unchanged for brevity */
    :root {
      --primary: #2c3e50;
      --accent: #3498db;
      --bg: #f5f7fa;
    }
    body {
      font-family: "Inter", "Segoe UI", "Roboto", sans-serif;
      background: linear-gradient(135deg, #d0e7f9, #f0f6ff, #d9f0fc);
      margin: 0;
      padding: 20px;
      color: var(--primary);
    }
    h1 {
      text-align: center;
      margin-top: -60px;
      font-size: 1.1rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #3498db, #8e44ad, #e74c3c, #f1c40f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .quarter-select {
      max-width: 500px;
      margin: 10px auto 20px;
      text-align: center;
      font-size: .8rem;
    }
    select {
      font-size: .75rem;
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid var(--accent);
      cursor: pointer;
      min-width: 160px;
    }
    .expense-table {
      max-width: 700px;
      margin: 0 auto 15px;
      width: 100%;
    }
    .expense-table table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    th {
      background: var(--accent);
      color: white;
      font-weight: normal;
    }
    tr.total td {
      background: #f0f6ff;
      font-weight: bold;
    }

    .chart-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 50px;
      max-width: 1000px;
      margin: 0 auto 15px;
    }
    .chart-container,
    .category-controls
    {
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      flex: 1 20%;
      max-width: 240px;
      min-width: 200px;
      font-size: .8rem;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .chart-container canvas
    {
      max-width: 100%;
      height: 200px !important;
    }
    .category-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8em;
    }
    .category-controls .reset-btn {
      margin-top: 8px;
      align-self: center;
      cursor: pointer;
      background: var(--accent);
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      font-weight: bold;
      font-size: .75rem;
    }
    
    #legend {
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      margin-top: 8px;
      gap: 10px;
      font-size: .7rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
	  flex-shrink: 0;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .note {
      max-width: 100%;
      margin: 10px auto;
      text-align: center;
      font-size: .8rem;
      color: #2c3e50;
      background: #eaf4fc;
      padding: 8px;
      border-left: 4px solid var(--accent);
      font-style: italic;
    }
    #scrollTopBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 12px;
      border-radius: 50%;
      font-size: 18px;
      display: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
      transition: background-color .3s ease;
      z-index: 100;
    }
    #scrollTopBtn:hover {
      background: #2980b9;
    }
    #messageContainer {
      display: none;
      text-align: center;
      font-style: italic;
      padding: 1em;
      margin-top: 1em;
      color: #555;
    }
    @media (max-width: 768px) {
      .chart-section {
        flex-direction: column;
        align-items: center;
      }
      .chart-container,
      .category-controls
      {
        max-width: 90vw;
        width: 100%;
      }
      .expense-table {
        max-width: 90vw;
      }
      h1 {
        text-align: center;
        font-size: 1rem;
      }
    }

  .note {
  background-color: #CCFFFF; /* very light gray */
  padding: 5px 10px;
  border-radius: 6px;
  border-left: 4px solid var(--accent); /* keeps your accent color border */
  font-style: italic;
  max-width: 800px;
  margin: 10px auto;
  color: #0070C0;
}
.negative-variance {
  color: red;
  font-weight: bold;
}
.positive-variance {
  color: green;
  font-weight: bold;
}

  </style>
</head>
<body>
  <main>
    <h1 id="pageTitle"></h1>

    <div class="quarter-select">
      <label for="quarterSelect"><strong>Select Quarter:</strong></label>
      <select id="quarterSelect" aria-label="Select Quarter">
        <option value="Q1-2025">Q1 2025 (Apr - Jun)</option>
        <option value="Q2-2025" selected> Q2 2025 (Jul - Sep)</option>
        <option value="Q3-2025">Q3 2025 (Oct - Dec)</option>
        <option value="Q4-2025">Q4 2025 (Jan2026 - Mar2026)</option>
      </select>
    </div>

    <div id="expenseSection" class="expense-table" aria-live="polite">
      <table aria-label="Expense Summary Table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Income (â‚¹)</th>
            <th>Expenditure (â‚¹)</th>
            <th>Variance (â‚¹)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
        <tfoot>
          <tr class="total">
            <td><strong>Total</strong></td>
            <td id="totalPlanned">â€“</td>
            <td id="totalActual">â€“</td>
            <td id="totalVariance">â€“</td>
            <td id="overallStatus">â€“</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <p class="note"><b>Note:</b> Some costs increased this quarter due to special festivals and urgent maintenance.</p>

    <div id="messageContainer"></div>

    <div class="chart-section" id="chartSection">
      <div class="chart-container" id="chartContainer">
        <canvas id="expenseChart"></canvas>
        <div id="legend"></div>
      </div>
      <div class="category-controls" id="categoryControls">
        <strong>Show/Hide Categories:</strong>
        <label><input type="checkbox" class="category-toggle" data-index="0" checked> Admin</label>
        <label><input type="checkbox" class="category-toggle" data-index="1" checked> Salaries</label>
        <label><input type="checkbox" class="category-toggle" data-index="2" checked> Utilities</label>
        <label><input type="checkbox" class="category-toggle" data-index="3" checked> Maintenance</label>
        <label><input type="checkbox" class="category-toggle" data-index="4" checked> Events</label>
        <button class="reset-btn">Reset All</button>
      </div>

    <button id="scrollTopBtn" aria-label="Scroll to top">â†‘</button>
  </main>

  <script>

  const categoryIcons = {
  "Admin": "ðŸ§¾",
  "Salaries": "ðŸ‘·",
  "Utilities": "ðŸ’¡",
  "Maintenance": "ðŸ› ",
  "Events": "ðŸŽ‰"
};

  const dataByQuarter = {
    "Q1-2025": { message: "Quarter - 1 is archived." },
    "Q2-2025": {
      categories: [
        { name: "Admin", amount: 13931, subitems: ["Auditor Fees", "Printing & Stationeries", "Meeting Exp", "Office & Conveyance Exp"] },
        { name: "Salaries", amount: 72654, subitems: ["Salaries and Wages", "Puja Bonus"] },
        { name: "Utilities", amount: 66876, subitems: ["CESC", "KMC Water Tax", "Cleaning&Swipping", "STP", "Electricity â€“ Borewell Pump", "Electricity â€“ Community Hall"] },
        { name: "Maintenance", amount: 104911, subitems: ["Maintenance & Contingency Fund", "Security Services", "AMC â€“ DG Set", "AMC â€“ Fire", "Pest Control", "AMC â€“ CC Tv", "Gardening"] },
        { name: "Events", amount: 3500, subitems: ["Biswakarma Puja", "Republic Day", "Independence Day", "Rabindra Jayanti"] }
      ],
      budgetTotal: 132680,
      status: "Closed"
    },
    "Q3-2025": { message: "Quarter - 3 data is not yet available as the quarter is still in progress." },
    "Q4-2025": { message: "Quarter - 4 is yet to begin." }
  };

  const categoryColors = ["#3498db", "#2ecc71", "#f1c40f", "#e67e22", "#9b59b6"];
  let expenseChart, budgetGaugeChart;
  let currentQuarter = "Q2-2025";

  function init() {
    updateUI(currentQuarter);

    document.getElementById("quarterSelect").addEventListener("change", (e) => {
      currentQuarter = e.target.value;
      updateUI(currentQuarter);
    });

    document.querySelector(".reset-btn").addEventListener("click", () => {
      document.querySelectorAll(".category-toggle").forEach(c => c.checked = true);
      updateChart();
    });

    document.querySelectorAll(".category-toggle").forEach(toggle => {
      toggle.addEventListener("change", () => updateChart());
    });

    window.addEventListener("scroll", () => {
      document.getElementById("scrollTopBtn").style.display = window.scrollY > 200 ? "block" : "none";
    });
    document.getElementById("scrollTopBtn").addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  function updateUI(q) {
  const data = dataByQuarter[q];
  const note = document.querySelector(".note");
  const expenseSection = document.getElementById("expenseSection");
  const chartSection = document.getElementById("chartSection");
  const messageContainer = document.getElementById("messageContainer");
  const pageTitle = document.getElementById("pageTitle");

  pageTitle.textContent = "Quarterly Income - Expenditure 2025 Snapshot";

  if (!data.categories) {
    expenseSection.style.display = "none";
    chartSection.style.display = "none";
    messageContainer.style.display = "block";
    messageContainer.textContent = data.message || "No data available.";
    note.style.display = "none";
    return; // prevent rendering chart/table for non-data quarters
  }

  note.style.display = (q === "Q2-2025") ? "block" : "none";
  note.innerHTML = "<strong>Note:</strong> A transparent summary of the association's finances. This quarter experienced a significant shortfall of <strong>97.37%</strong> due to AMC renewal, festivals, and urgent maintenance jobs. Sincere thanks for your unwavering support.";

  expenseSection.style.display = "block";
  chartSection.style.display = "flex";
  messageContainer.style.display = "none";

  // Don't auto-reset checkboxes; retain user selection
  updateChart(); // render based on current toggle states
}

  function populateTable(data) {
  const tbody = document.getElementById("expenseTableBody");
  tbody.innerHTML = "";

  const toggles = document.querySelectorAll(".category-toggle");
  let totalActual = 0;

  data.categories.forEach((cat, i) => {
    if (!toggles[i].checked) return;

    totalActual += cat.amount;

    const tr = document.createElement("tr");
    tr.classList.add("category-row");
    tr.setAttribute("data-index", i);
    tr.style.cursor = "pointer";

    // Actual expense shown only for categories, not subcategories
    tr.innerHTML = `
      <td><span class="expand-sign">[+]</span> <strong>${categoryIcons[cat.name] || ""} ${cat.name}</strong></td>
      <td></td>
      <td>â‚¹${cat.amount.toLocaleString()}</td>
      <td></td>
      <td>${data.status}</td>
    `;

    tbody.appendChild(tr);
	

    // Subcategory rows (hidden initially)
    cat.subitems.forEach(subName => {
      const subTr = document.createElement("tr");
      subTr.classList.add("subcategory-row", `parent-${i}`);
      subTr.style.display = "none";
      subTr.innerHTML = `
        <td style="padding-left: 20px;">â†³ ${subName}</td>
        <td colspan="4"></td>
      `;
      tbody.appendChild(subTr);
    });
  });
  
  // Insert info row before total
    const infoRow = document.createElement("tr");
    infoRow.innerHTML = `
      <td colspan="5" style="text-align:center; font-style:italic; background:#f9f9f9;">
        This quarterâ€™s income includes <strong>â‚¹35,000</strong> as new memberships and <strong>â‚¹5,000</strong> as development fund.
      </td>
    `;
    tbody.appendChild(infoRow);

  // Calculate variance
  const variance = data.budgetTotal - totalActual;
  const varianceClass = variance < 0 ? "negative-variance" : "positive-variance";
  const varianceText = variance < 0 ? `-â‚¹${Math.abs(variance).toLocaleString()}` : `â‚¹${variance.toLocaleString()}`;

  // Update footer total row values directly
  document.getElementById("totalPlanned").textContent = `â‚¹${data.budgetTotal.toLocaleString()}`;
  document.getElementById("totalActual").textContent = `â‚¹${totalActual.toLocaleString()}`;

  const totalVarianceCell = document.getElementById("totalVariance");
  totalVarianceCell.textContent = varianceText;
  totalVarianceCell.className = varianceClass;

  document.getElementById("overallStatus").textContent = data.status;

  // Expand/collapse functionality
  document.querySelectorAll(".category-row").forEach(row => {
    row.onclick = () => {
      const idx = row.getAttribute("data-index");
      const subRows = document.querySelectorAll(`.subcategory-row.parent-${idx}`);
      const signSpan = row.querySelector(".expand-sign");
      const isHidden = subRows[0]?.style.display === "none";

      subRows.forEach(sr => {
        sr.style.display = isHidden ? "table-row" : "none";
      });

      signSpan.textContent = isHidden ? "[-]" : "[+]";
    };
  });
}

 function renderChart(data) {
  const canvas = document.getElementById("expenseChart");
  const ctx = canvas.getContext("2d");
  const toggles = document.querySelectorAll(".category-toggle");
  const filtered = data.categories.filter((_, i) => toggles[i].checked);

  if (expenseChart) expenseChart.destroy();

  expenseChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: filtered.map(c => c.name),
      datasets: [{
        data: filtered.map(c => c.amount),
        backgroundColor: filtered.map((_, i) => categoryColors[i % categoryColors.length]),
        borderColor: "#fff",
        borderWidth: 3
      }]
    },
    options: {
      plugins: {
        datalabels: {
          color: "#000",
          formatter: (val) => val > 0 ? "â‚¹" + val.toLocaleString() : "",
          font: { weight: "bold", size: 12 },
          anchor: 'center',
          clamp: true,
          display: true
        },
        legend: {
          display: false,
          position: "bottom",
          labels: { font: { size: 12 } }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.label || "";
              const val = ctx.raw || 0;
              return `${label}: â‚¹${val.toLocaleString()}`;
            }
          }
        }
      },
      cutout: "60%",
      responsive: true,
      maintainAspectRatio: false
    },
    plugins: [ChartDataLabels]
  });

  updateLegend(filtered);
}


  function updateLegend(categories) {
    const legendContainer = document.getElementById("legend");
    legendContainer.innerHTML = "";
    categories.forEach((cat, i) => {
      const div = document.createElement("div");
      div.className = "legend-item";
      div.innerHTML = `<span class="legend-color" style="background:${categoryColors[i]}"></span>${cat.name}`;
      legendContainer.appendChild(div);
    });
  }

  function updateChart() {
  const data = dataByQuarter[currentQuarter];
  if (!data || !data.categories) return;

  const toggles = Array.from(document.querySelectorAll(".category-toggle"));
  const filteredCategories = data.categories.filter((_, i) => toggles[i].checked);

  // Only pass filtered categories
  populateTable({ ...data, categories: filteredCategories });
  renderChart({ ...data, categories: filteredCategories });
}


   window.onload = init;
  AOS.init({ once: true });
</script>


</body>
</html>
